<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Inserimento Dati ‚Äì HOMBU 9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; margin: 2rem; background: #f8f8f8; color: #333; }
    h1, h2 { color: #1155cc; }
    label, select { display: block; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    input[type="number"] { width: 4rem; }
    input[readonly] { background-color: #eee; }
    button, .button-home {
      margin-top: 1rem; padding: 0.5rem 1rem;
      background: #1155cc; color: white;
      border: none; border-radius: 4px; cursor: pointer;
      text-decoration: none;
    }
    button:hover, .button-home:hover { background-color: #0d3e99; }
    #messaggio-successo {
      margin-top: 2rem; padding: 1rem;
      background-color: #d4edda; color: #155724; display: none;
    }
    .modal-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; justify-content: center; align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 8px; text-align: center;
    }
    .modal-buttons { margin-top: 1rem; }
    .modal-btn { margin: 0 1rem; padding: 0.5rem 1rem; font-size: 1rem; }
    .conferma { background-color: #28a745; color: white; }
    .annulla { background-color: #dc3545; color: white; }
  </style>
</head>
<body>
  <h1>Inserimento Dati ‚Äì HOMBU6</h1>
  <form id="dati-form">
    <label for="anno">Anno:
      <select name="anno" id="anno" required></select>
    </label>
    <label for="mese">Mese:
      <select name="mese" id="mese" required></select>
    </label>
    <label for="gruppo">Gruppo:
      <select name="gruppo" id="gruppo" required></select>
    </label>

    <h2>ZADANKAI</h2>
    <table id="zadankai-table">
      <thead>
        <tr><th>Categoria</th><th>U</th><th>D</th><th>GU</th><th>GD</th><th>TOTALE</th><th>FUT</th><th>STU</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>Membri</td>
          <td><input type="number" name="zadankai_m_u"></td>
          <td><input type="number" name="zadankai_m_d"></td>
          <td><input type="number" name="zadankai_m_gu"></td>
          <td><input type="number" name="zadankai_m_gd"></td>
          <td><input type="number" name="zadankai_m_tot" readonly></td>
          <td><input type="number" name="zadankai_m_fut"></td>
          <td><input type="number" name="zadankai_m_stu"></td>
        </tr>
        <tr>
          <td>Simpatizzanti</td>
          <td><input type="number" name="zadankai_s_u"></td>
          <td><input type="number" name="zadankai_s_d"></td>
          <td><input type="number" name="zadankai_s_gu"></td>
          <td><input type="number" name="zadankai_s_gd"></td>
          <td><input type="number" name="zadankai_s_tot" readonly></td>
          <td><input type="number" name="zadankai_s_fut"></td>
          <td><input type="number" name="zadankai_s_stu"></td>
        </tr>
        <tr>
          <td>Ospiti</td>
          <td><input type="number" name="zadankai_o_u"></td>
          <td><input type="number" name="zadankai_o_d"></td>
          <td><input type="number" name="zadankai_o_gu"></td>
          <td><input type="number" name="zadankai_o_gd"></td>
          <td><input type="number" name="zadankai_o_tot" readonly></td>
          <td colspan="2">‚Äì</td>
        </tr>
        <tr>
          <td colspan="5" style="text-align:right"><strong>TOTALE GENERALE</strong></td>
          <td><input type="number" name="zadankai_totale_generale" readonly></td>
          <td colspan="2"></td>
        </tr>
      </tbody>
    </table>

    <h2>PRATICANTI</h2>
    <table id="praticanti-table">
      <thead>
        <tr><th>Categoria</th><th>U</th><th>D</th><th>GU</th><th>GD</th><th>TOTALE</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>Membri</td>
          <td><input type="number" name="praticanti_m_u"></td>
          <td><input type="number" name="praticanti_m_d"></td>
          <td><input type="number" name="praticanti_m_gu"></td>
          <td><input type="number" name="praticanti_m_gd"></td>
          <td><input type="number" name="praticanti_m_tot" readonly></td>
        </tr>
        <tr>
          <td>Simpatizzanti</td>
          <td><input type="number" name="praticanti_s_u"></td>
          <td><input type="number" name="praticanti_s_d"></td>
          <td><input type="number" name="praticanti_s_gu"></td>
          <td><input type="number" name="praticanti_s_gd"></td>
          <td><input type="number" name="praticanti_s_tot" readonly></td>
        </tr>
        <tr>
          <td colspan="5" style="text-align:right"><strong>TOTALE GENERALE</strong></td>
          <td><input type="number" name="praticanti_totale_generale" readonly></td>
        </tr>
      </tbody>
    </table>

    <button type="submit">Salva dati</button>
    <a href="index.html" class="button-home">üè† Torna alla Home</a>

    <div id="messaggio-successo">
      ‚úÖ Dati salvati con successo!
      <a href="index.html" style="margin-left: 1rem; font-weight: bold;">üè† Torna alla Home</a>
    </div>

    <div id="popup-conferma" class="modal-overlay">
      <div class="modal-content">
        <p>Confermi l'invio dei dati?</p>
        <div class="modal-buttons">
          <button id="confermaBtn" class="modal-btn conferma">‚úîÔ∏è Conferma</button>
          <button id="annullaBtn" class="modal-btn annulla">‚ùå Annulla</button>
        </div>
      </div>
    </div>
  </form>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
  import { firebaseConfig } from "./firebase-config.js";

  document.addEventListener("DOMContentLoaded", () => {
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ‚è≥ Popola anno e mese
    const anno = new Date().getFullYear();
    document.getElementById("anno").innerHTML =
      `<option value="${anno}" selected>${anno}</option><option value="${anno + 1}">${anno + 1}</option>`;

    const mesi = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
      "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    document.getElementById("mese").innerHTML =
      '<option value="">‚Äì</option>' + mesi.map(m => `<option>${m}</option>`).join("");

    // üì¶ Carica gruppi HOMBU
    fetch("gruppi.json")
      .then(res => res.json())
      .then(data => {
        const gruppi = [];
        for (const capitolo of Object.values(data["HOMBU 9"])) {
          for (const settore of Object.values(capitolo)) {
            gruppi.push(...settore);
          }
        }
        document.getElementById("gruppo").innerHTML =
          '<option value="">‚Äì</option>' + gruppi.map(g => `<option>${g}</option>`).join("");
      });

    // üîê Blocca input non validi
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener("keypress", e => {
        if (!/[0-9]/.test(e.key)) e.preventDefault();
      });
      input.addEventListener("paste", e => {
        const pasted = (e.clipboardData || window.clipboardData).getData("text");
        if (!/^\d+$/.test(pasted)) e.preventDefault();
      });
      input.addEventListener("wheel", e => e.target.blur());
    });

    // üßÆ Calcolo totali Zadankai
    const calcolaTotaliZadankai = () => {
      const sezioni = ["m", "s", "o"];
      let totaleGenerale = 0;
      sezioni.forEach(sezione => {
        const u = +document.querySelector(`[name="zadankai_${sezione}_u"]`).value || 0;
        const d = +document.querySelector(`[name="zadankai_${sezione}_d"]`).value || 0;
        const gu = +document.querySelector(`[name="zadankai_${sezione}_gu"]`).value || 0;
        const gd = +document.querySelector(`[name="zadankai_${sezione}_gd"]`).value || 0;
        const somma = u + d + gu + gd;
        document.querySelector(`[name="zadankai_${sezione}_tot"]`).value = somma;
        totaleGenerale += somma;
      });
      document.querySelector(`[name="zadankai_totale_generale"]`).value = totaleGenerale;
    };

    // üßÆ Calcolo totali Praticanti
    const calcolaTotaliPraticanti = () => {
      const sezioni = ["m", "s"];
      let totaleGenerale = 0;
      sezioni.forEach(sezione => {
        const u = +document.querySelector(`[name="praticanti_${sezione}_u"]`).value || 0;
        const d = +document.querySelector(`[name="praticanti_${sezione}_d"]`).value || 0;
        const gu = +document.querySelector(`[name="praticanti_${sezione}_gu"]`).value || 0;
        const gd = +document.querySelector(`[name="praticanti_${sezione}_gd"]`).value || 0;
        const somma = u + d + gu + gd;
        document.querySelector(`[name="praticanti_${sezione}_tot"]`).value = somma;
        totaleGenerale += somma;
      });
      document.querySelector(`[name="praticanti_totale_generale"]`).value = totaleGenerale;
    };

    // üì° Attiva aggiornamento live dei totali
    document.querySelectorAll('#zadankai-table input[type="number"]').forEach(input => {
      input.addEventListener("input", calcolaTotaliZadankai);
    });
    document.querySelectorAll('#praticanti-table input[type="number"]').forEach(input => {
      input.addEventListener("input", calcolaTotaliPraticanti);
    });

    // üü¶ Mostra popup
    document.getElementById("dati-form").addEventListener("submit", e => {
      e.preventDefault();
      document.getElementById("popup-conferma").style.display = "flex";
    });

    // ‚úîÔ∏è Conferma ‚Üí chiudi e salva
    document.getElementById("confermaBtn").addEventListener("click", () => {
      document.getElementById("popup-conferma").style.display = "none";
      salvaDati();
    });

    // ‚ùå Annulla ‚Üí solo chiudi popup
    document.getElementById("annullaBtn").addEventListener("click", () => {
      document.getElementById("popup-conferma").style.display = "none";
    });

    // üíæ Salvataggio Firebase
    function salvaDati() {
      const form = document.getElementById("dati-form");
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      const key = `${data.anno}-${data.mese}-${data.gruppo}`;

      const payload = {
        gruppo: data.gruppo,
        zadankai: {
          membri: {
            U: +data.zadankai_m_u || 0,
            D: +data.zadankai_m_d || 0,
            GU: +data.zadankai_m_gu || 0,
            GD: +data.zadankai_m_gd || 0,
            FUT: +data.zadankai_m_fut || 0,
            STU: +data.zadankai_m_stu || 0
          },
          simpatizzanti: {
            U: +data.zadankai_s_u || 0,
            D: +data.zadankai_s_d || 0,
            GU: +data.zadankai_s_gu || 0,
            GD: +data.zadankai_s_gd || 0,
            FUT: +data.zadankai_s_fut || 0,
            STU: +data.zadankai_s_stu || 0
          },
          ospiti: {
            U: +data.zadankai_o_u || 0,
            D: +data.zadankai_o_d || 0,
            GU: +data.zadankai_o_gu || 0,
            GD: +data.zadankai_o_gd || 0
          }
        },
        praticanti: {
          membri: {
            U: +data.praticanti_m_u || 0,
            D: +data.praticanti_m_d || 0,
            GU: +data.praticanti_m_gu || 0,
            GD: +data.praticanti_m_gd || 0
          },
          simpatizzanti: {
            U: +data.praticanti_s_u || 0,
            D: +data.praticanti_s_d || 0,
            GU: +data.praticanti_s_gu || 0,
            GD: +data.praticanti_s_gd || 0
          }
        }
      };

      set(ref(db, `zadankai/${key}`), payload)
        .then(() => {
          document.getElementById("messaggio-successo").style.display = "block";
          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        })
        .catch(err => alert("‚ùå Errore nel salvataggio: " + err.message));
    }
  });
</script>


</body>
</html>
