<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Visualizza Dati – HOMBU 9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 2rem;
      color: #333;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 1rem;
    }

    label {
      display: inline-block;
      margin: 0.5rem 1rem 0.5rem 0;
      font-weight: 500;
    }

    select {
      font-size: 1.1rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 180px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
      background: white;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.6rem;
      text-align: center;
    }

    th {
      background: #e0f7fa;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>
</head>
<body>

  <h1>Visualizza Dati – HOMBU 9</h1>

  <label>Anno:
    <select id="filtro-anno"><option value="">Tutti</option></select>
  </label>
  <label>Mese:
    <select id="filtro-mese"><option value="">Tutti</option></select>
  </label>
  <label>Gruppo:
    <select id="filtro-gruppo"><option value="">Tutti</option></select>
  </label>

  <table id="tabella-dati">
    <thead>
      <tr>
        <th>Nome Gruppo</th>
        <th>Categoria</th>
        <th>U</th>
        <th>D</th>
        <th>GU</th>
        <th>GD</th>
        <th>Somma</th>
        <th>Totale</th>
        <th>Futuro</th>
        <th>Studenti</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tbody = document.querySelector("#tabella-dati tbody");
    const filtroAnno = document.getElementById("filtro-anno");
    const filtroMese = document.getElementById("filtro-mese");
    const filtroGruppo = document.getElementById("filtro-gruppo");

    get(child(ref(db), "zadankai")).then(snapshot => {
      if (!snapshot.exists()) return;

      const dati = snapshot.val();
      const righe = [];

      for (const key in dati) {
        const [anno, mese, gruppo] = key.split("-");
        const sezioni = dati[key];

        for (const categoria in sezioni.zadankai) {
          const r = sezioni.zadankai[categoria];
          righe.push({
            anno, mese, gruppo, categoria: "ZADANKAI – " + categoria,
            tipo: "ZADANKAI",
            sezione: categoria,
            U: r.U ?? 0, D: r.D ?? 0, GU: r.GU ?? 0, GD: r.GD ?? 0,
            FUT: r.FUT ?? "-", STU: r.STU ?? "-"
          });
        }

        for (const categoria in sezioni.praticanti) {
          const r = sezioni.praticanti[categoria];
          righe.push({
            anno, mese, gruppo, categoria: "PRATICANTI – " + categoria,
            tipo: "PRATICANTI",
            sezione: categoria,
            U: r.U ?? 0, D: r.D ?? 0, GU: r.GU ?? 0, GD: r.GD ?? 0,
            FUT: "-", STU: "-"
          });
        }
      }

      const unici = (arr, campo) => [...new Set(arr.map(r => r[campo]))].sort();
      unici(righe, "anno").forEach(v => filtroAnno.add(new Option(v, v)));
      unici(righe, "mese").forEach(v => filtroMese.add(new Option(v, v)));
      unici(righe, "gruppo").forEach(v => filtroGruppo.add(new Option(v, v)));

      [filtroAnno, filtroMese, filtroGruppo].forEach(f =>
        f.addEventListener("change", aggiornaTabella)
      );

      function aggiornaTabella() {
        tbody.innerHTML = "";

        const gruppiUnici = [...new Set(righe.map(r => r.gruppo))].sort();

        gruppiUnici.forEach(gruppo => {
          const righeGruppo = righe.filter(r =>
            r.gruppo === gruppo &&
            (!filtroAnno.value || r.anno === filtroAnno.value) &&
            (!filtroMese.value || r.mese === filtroMese.value)
          );

          if (righeGruppo.length === 0) return;

          const categorie = [
            { tipo: "ZADANKAI", sezioni: ["membri", "simpatizzanti", "ospiti"] },
            { tipo: "PRATICANTI", sezioni: ["membri", "simpatizzanti"] }
          ];

          categorie.forEach(cat => {
            cat.sezioni.forEach(sezione => {
              const r = righeGruppo.find(x => x.categoria === `${cat.tipo} – ${sezione}`);
              if (!r) return;

              const somma = r.U + r.D + r.GU + r.GD;
              const totale = somma;

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${gruppo}</td>
                <td>${cat.tipo} – ${sezione}</td>
                <td>${r.U}</td>
                <td>${r.D}</td>
                <td>${r.GU}</td>
                <td>${r.GD}</td>
                <td>${somma}</td>
                <td>${totale}</td>
                <td>${r.FUT}</td>
                <td>${r.STU}</td>
              `;
              tbody.appendChild(tr);
            });
          });
        });
      }

      aggiornaTabella();
    });
  </script>
</body>
</html>
